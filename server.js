const express = require('express');
const cors = require('cors');
const stripe = require('stripe')(process.env.STRIPE_SECRET_KEY);

const app = express();
app.use(express.json());
app.use(cors({ origin: '*' })); // Ð’ Ð¿Ñ€Ð¾Ð´Ð°ÐºÑˆÐ½Ðµ Ð·Ð°Ð¼ÐµÐ½Ð¸Ñ‚Ðµ '*' Ð½Ð° Ð²Ð°Ñˆ Ð´Ð¾Ð¼ÐµÐ½

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// POST /create-payment-intent
// Body: { amount: 149, currency: 'eur' }
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
app.post('/create-payment-intent', async (req, res) => {
  const { amount, currency = 'eur' } = req.body;

  if (!amount || amount < 1) {
    return res.status(400).json({ error: 'ÐÐµÐ²ÐµÑ€Ð½Ð°Ñ ÑÑƒÐ¼Ð¼Ð°' });
  }

  try {
    const paymentIntent = await stripe.paymentIntents.create({
      amount,        // Ð² Ñ†ÐµÐ½Ñ‚Ð°Ñ…: 149 = â‚¬1.49
      currency,
      automatic_payment_methods: { enabled: true },
    });

    res.json({ clientSecret: paymentIntent.client_secret });
  } catch (err) {
    console.error('Stripe error:', err.message);
    res.status(500).json({ error: err.message });
  }
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// POST /webhook  (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾ â€” Ð´Ð»Ñ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ñ Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ)
// ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹Ñ‚Ðµ Webhook Ð² Stripe Dashboard â†’ Developers â†’ Webhooks
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
app.post('/webhook', express.raw({ type: 'application/json' }), (req, res) => {
  const sig = req.headers['stripe-signature'];
  const endpointSecret = process.env.STRIPE_WEBHOOK_SECRET;

  let event;
  try {
    event = stripe.webhooks.constructEvent(req.body, sig, endpointSecret);
  } catch (err) {
    console.error('Webhook error:', err.message);
    return res.status(400).send(`Webhook Error: ${err.message}`);
  }

  if (event.type === 'payment_intent.succeeded') {
    const pi = event.data.object;
    console.log(`âœ… ÐžÐ¿Ð»Ð°Ñ‚Ð° ÑƒÑÐ¿ÐµÑˆÐ½Ð°: ${pi.id} â€” ${pi.amount / 100}â‚¬`);
    // TODO: Ð²Ñ‹Ð´Ð°Ñ‚ÑŒ Ð´Ð¾ÑÑ‚ÑƒÐ¿ Ð¸Ð³Ñ€Ð¾ÐºÑƒ, Ð·Ð°Ð¿Ð¸ÑÐ°Ñ‚ÑŒ Ð² Ð‘Ð” Ð¸ Ñ‚.Ð´.
  }

  res.json({ received: true });
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Health check
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
app.get('/', (req, res) => {
  res.json({ status: 'NEON BLASTER Server running ðŸš€' });
});

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`Server started on port ${PORT}`);
});
